# short-description: Create SD card image with a boot partition
# long-description:
# Create an image that can be written onto a SD card using dd for use
# with am335x-phytec-wega.
# It uses SPL and u-boot
#
# The disk layout used is:
#  ----- --------- --------------
# | MLO | u-boot  |    rootfs    |
#  ----- --------- --------------
# ^     ^         ^              ^
# |     |         |              |
# 128K  384K      4MiB + rootfs + IMAGE_EXTRA_SPACE (default 10MiB)
#
part SPL --source rawcopy --sourceparams="file=MLO" --ondisk mmcblk --no-table --align 128
part u-boot --source rawcopy --sourceparams="file=u-boot.img" --ondisk mmcblk --no-table --align 384
part / --source rootfs --ondisk mmcblk --fstype=ext4 --label root --align 4096

# -->
# bitbake wic-tools
# wic create ../u-boot-wic-bsp/wic/am335x-phytec-wega-sd-card.wks -e core-image-minimal
# wic create ../am335x-phytec-wega-bsp/wic/am335x-phytec-wega-sd-card.wks -e core-image-minimal
# INFO: Creating image(s)...
#
# WARNING: bootloader config not specified, using defaults
#
# INFO: The new image(s) can be found here:
#  ./am335x-phytec-wega-sd-card-201706031949-mmcblk.direct
#
#The following build artifacts were used to create the image(s):
#  ROOTFS_DIR:                   /tmp/yocto-autobuilder/yocto-autobuilder/yocto-worker/poky-custom-pyro-multi-v7-core-image-minimal/build/tmp/work/am335x_phytec_wega_bsp-poky-linux-gnueabi/core-image-minimal/1.0-r0/rootfs
#  BOOTIMG_DIR:                  /tmp/yocto-autobuilder/yocto-autobuilder/yocto-worker/poky-custom-pyro-multi-v7-core-image-minimal/build/tmp/work/am335x_phytec_wega_bsp-poky-linux-gnueabi/core-image-minimal/1.0-r0/recipe-sysroot/usr/share
#  KERNEL_DIR:                   /tmp/yocto-autobuilder/yocto-autobuilder/yocto-worker/poky-custom-pyro-multi-v7-core-image-minimal/build/tmp/deploy/images/am335x-phytec-wega-bsp
#  NATIVE_SYSROOT:               /tmp/yocto-autobuilder/yocto-autobuilder/yocto-worker/poky-custom-pyro-multi-v7-core-image-minimal/build/tmp/work/am335x_phytec_wega_bsp-poky-linux-gnueabi/core-image-minimal/1.0-r0/recipe-sysroot-native
#
#INFO: The image(s) were created using OE kickstart file:
#  ../am335x-phytec-wega-bsp/wic/am335x-phytec-wega-sd-card.wks
#
# <--

# Notes: (hacked together manually for now and made it work)
# Those things need to be integrated into Yocto:
# 1) we need a patched version of u-boot which also searches for uEnv.txt on ext4 or so partition and not only fat
# 2) we need to add uEnv.txt to / of the rootfs [OK]
# 3) the generated file to be flashed with etcher needs to be ending with .raw or so
# 4) create a bitbake wks target automativally
